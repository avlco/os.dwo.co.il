// @ts-nocheck
import { createClientFromRequest } from 'npm:@base44/sdk@0.8.6';

const SHEET_ID = 'YOUR_GOOGLE_SHEET_ID_HERE'; // â­ ×©×™× ××ª ×”-ID ×©×œ ×”×’×™×œ×™×•×Ÿ
const API_KEY = Deno.env.get('GOOGLE_SHEETS_API_KEY'); // ×¦×¨×™×š ×œ×”×•×¡×™×£ ×‘-Settings

Deno.serve(async (req) => {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  };

  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const base44 = createClientFromRequest(req);
    
    // ×§×‘×œ ××ª TimeEntry ID ××”-request
    const { timeEntryId } = await req.json();
    
    if (!timeEntryId) {
      throw new Error('timeEntryId is required');
    }

    // ×©×œ×•×£ ××ª TimeEntry
    const timeEntry = await base44.entities.TimeEntry.get(timeEntryId);
    if (!timeEntry) {
      throw new Error(`TimeEntry not found: ${timeEntryId}`);
    }

    // ×©×œ×•×£ Case
    const caseData = timeEntry.case_id 
      ? await base44.entities.Case.get(timeEntry.case_id) 
      : null;

    // ×©×œ×•×£ Client
    const client = caseData?.client_id 
      ? await base44.entities.Client.get(caseData.client_id) 
      : null;

    // ×©×œ×•×£ User (×¢×•"×“)
    const lawyer = timeEntry.user_email
      ? await base44.entities.User.filter({ email: timeEntry.user_email }).then(users => users?.[0])
      : null;

    // ğŸ”¥ ×‘× ×” ×©×•×¨×” ×œ×’×•×’×œ ×©×™×˜×¡
    const row = [
      lawyer?.name || timeEntry.user_email || '', // ×©× ×¢×•×´×“
      client ? `${client.id} - ${client.name}` : '', // ×œ×§×•×—
      caseData?.case_number || '', // ××¡×³ ×ª×™×§
      timeEntry.date_worked || new Date().toISOString().split('T')[0], // ×ª××¨×™×š
      timeEntry.hours || 0, // ×¡×”"×› ×©×¢×•×ª
      '×©×¢×•×ª', // ×™×—×™×“×”
      timeEntry.description || '', // ×¤×™×¨×•×˜
      (timeEntry.hours || 0) * (timeEntry.rate || 0), // ×¡×”"×› ×œ×—×™×•×‘
      'â‚ª + ××¢"×', // ××˜×‘×¢
      timeEntry.invoice_id || '', // ×—×©×‘×•×Ÿ ×¢×¡×§×”
      '' // ×”×¢×¨×•×ª
    ];

    // ×©×œ×— ×œ-Google Sheets API
    const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1!A:K:append?valueInputOption=USER_ENTERED&key=${API_KEY}`;
    
    const response = await fetch(sheetsUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        values: [row]
      })
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`Google Sheets API failed: ${error}`);
    }

    const result = await response.json();

    return new Response(JSON.stringify({
      success: true,
      timeEntryId: timeEntry.id,
      sheetsResponse: result
    }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });

  } catch (error) {
    console.error('[SheetsSync] Error:', error);
    return new Response(JSON.stringify({
      error: error.message
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    });
  }
});
